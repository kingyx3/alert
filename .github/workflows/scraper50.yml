name: Scraper50

on:
  workflow_dispatch:
    inputs:
      scraping_url:
        description: 'URL to scrape'
        required: false
        type: string
      scraping_url_2:
        description: 'URL to scrape for scraper2'
        required: false
        type: string

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Restore pip & venv cache
      id: cache-pip-venv
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          .venv
        key: ${{ runner.os }}-pip-3.9-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-3.9-

    - name: Create virtualenv (if missing)
      run: |
        if [ ! -d ".venv" ]; then
          python -m venv .venv
        fi

    - name: Install dependencies (only if cache miss)
      if: steps.cache-pip-venv.outputs.cache-hit != 'true'
      run: |
        source .venv/bin/activate
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Delay before starting scraper
      run: |
        echo "Waiting 50 seconds before running scraper..."
        sleep 50

    - name: Run scraper
      id: scraper1
      continue-on-error: true
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        SCRAPING_URL: ${{ inputs.scraping_url || vars.SCRAPING_URL }}
      run: |
        source .venv/bin/activate
        python scraper.py
      
    - name: Run scraper2
      id: scraper2
      continue-on-error: true
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
        SCRAPING_URL_2: ${{ inputs.scraping_url_2 || vars.SCRAPING_URL_2 }}
      run: |
        source .venv/bin/activate
        python scraper2.py

    - name: Check scraper results
      run: |
        echo "Scraper 1 result: ${{ steps.scraper1.outcome }}"
        echo "Scraper 2 result: ${{ steps.scraper2.outcome }}"
        if [[ "${{ steps.scraper1.outcome }}" == "failure" || "${{ steps.scraper2.outcome }}" == "failure" ]]; then
          echo "At least one scraper failed. Failing the workflow."
          exit 1
        else
          echo "All scrapers completed successfully."
        fi